<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutenix</title>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
        // Polyfill for Tauri invoke if not available
        window.__TAURI_INVOKE__ = window.__TAURI_INVOKE__ || function(cmd, args) {
            return window.__TAURI_INTERNALS__.invoke(cmd, args);
        };
    </script>
    <style>
        :root {
            --primary-color: #666;
            --primary-dark: #333;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            background-color: #f4f4f4;
            color: #333;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--primary-color);
            color: #fff;
            padding: 1rem 0;
            text-align: center;
            margin-bottom: 0;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 0.5rem;
        }

        .header p {
            margin: 0;
            opacity: 0.9;
        }

        /* Tab Navigation */
        .tabs {
            background: white;
            border-bottom: 2px solid var(--border-color);
            padding: 0;
            margin-bottom: 0;
        }

        .tab-list {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-button {
            padding: 0.6rem 1.25rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: #f8f8f8;
            color: #333;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        main {
            padding: 0.5rem;
        }

        .status-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1.1em;
            margin-bottom: 0.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.connected {
            background-color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }

        .status-indicator.disconnected {
            background-color: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }

        .status-info {
            display: grid;
            gap: 4px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .status-row:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 600;
            color: #666;
        }

        .status-value {
            color: #333;
        }

        .logs-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .log-card {
            background: #fff;
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .log-card h3 {
            font-size: 1.1em;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .log-entries {
            flex: 1;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #999;
            margin-right: 8px;
        }

        .log-level {
            font-weight: bold;
            margin-right: 8px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .log-level.INFO {
            background-color: #3b82f6;
            color: white;
        }

        .log-level.WARN {
            background-color: #f59e0b;
            color: white;
        }

        .log-level.ERROR {
            background-color: #ef4444;
            color: white;
        }

        .log-level.DEBUG {
            background-color: #6b7280;
            color: white;
        }

        .log-message {
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge.danger {
            background-color: #fee2e2;
            color: #991b1b;
        }

        footer {
            background: #333;
            color: #fff;
            text-align: center;
            padding: 1rem 0;
            width: 100%;
            margin-top: 30px;
        }

        footer a {
            color: #fff;
            text-decoration: none;
        }

        footer a:hover {
            color: #ddd;
            text-decoration: underline;
        }

        /* Scrollbar styling */
        .log-entries::-webkit-scrollbar {
            width: 8px;
        }

        .log-entries::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .log-entries::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .log-entries::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Config page styles */
        .config-section {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }

        .config-section h3 {
            margin-bottom: 0.75rem;
            padding-bottom: 0.3rem;
            border-bottom: 2px solid var(--border-color);
            color: var(--primary-dark);
            font-size: 1.15em;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-group-inline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0;
        }

        .form-group-inline label {
            margin-bottom: 0;
            white-space: nowrap;
            min-width: fit-content;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-group-inline input,
        .form-group-inline select,
        .form-group-inline textarea {
            flex: 1;
            min-width: 120px;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: white;
            transition: all 0.2s ease;
        }

        .form-group-inline input:hover,
        .form-group-inline select:hover {
            border-color: #d1d5db;
        }

        .form-group-inline select {
            max-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background-color: white;
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #d1d5db;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #6366f1;
            color: white;
        }

        .btn-primary:hover {
            background: #4f46e5;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 0.35rem 0.75rem;
            font-size: 0.85rem;
            border-radius: 5px;
        }

        .config-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }

        .config-list {
            list-style: none;
            padding: 0;
        }

        .config-list-item {
            padding: 0.75rem;
            margin-bottom: 0.4rem;
            background: #f8f8f8;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-list-item:hover {
            background: #f0f0f0;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .alert {
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 0.75rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid var(--danger-color);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .code-editor {
            font-family: 'Monaco', 'Courier New', monospace;
            min-height: 400px;
            resize: vertical;
        }

        /* Visual Editor Styles */
        .editor-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .editor-mode {
            display: none;
        }

        .editor-mode.active {
            display: block;
        }

        .button-config-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s ease;
        }

        .button-config-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .button-config-item h4 {
            margin-bottom: 0.5rem;
            color: var(--primary-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.05em;
        }

        .action-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .action-item:hover {
            background: #f3f4f6;
        }

        .action-type-badge {
            display: inline-block;
            padding: 0.25rem 0.65rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #e0e7ff;
            color: #4338ca;
            border: 1px solid #c7d2fe;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .action-type-badge:hover {
            background: #c7d2fe;
            border-color: #a5b4fc;
        }

        .action-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.25rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 180px;
            display: none;
        }

        .action-type-dropdown.show {
            display: block;
        }

        .action-type-dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
            font-size: 0.85rem;
        }

        .action-type-dropdown-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .action-type-dropdown-item:last-child {
            border-radius: 0 0 6px 6px;
        }

        .action-type-dropdown-item:hover {
            background: #f3f4f6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        select {
            appearance: none;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.65rem center;
            padding-right: 2.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:hover {
            border-color: #d1d5db;
        }

        select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Mutenix</h1>
        <p>Device & Teams Control Center</p>
    </div>

    <div class="tabs">
        <ul class="tab-list">
            <li><button class="tab-button active" data-tab="dashboard">Dashboard</button></li>
            <li><button class="tab-button" data-tab="config">Configuration</button></li>
        </ul>
    </div>

    <div class="container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <main>
                <div class="status-cards">
                    <div class="card">
                        <h2>
                            <span class="status-indicator" id="device-indicator"></span>
                            Device Status
                        </h2>
                        <div class="status-info">
                    <div class="status-row">
                        <span class="status-label">Connection</span>
                        <span class="status-value" id="device-connection">
                            <span class="badge danger">Disconnected</span>
                        </span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Manufacturer</span>
                        <span class="status-value" id="device-manufacturer">-</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Product</span>
                        <span class="status-value" id="device-product">-</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Serial Number</span>
                        <span class="status-value" id="device-serial">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>
                    <span class="status-indicator" id="teams-indicator"></span>
                    Teams Status
                </h2>
                <div class="status-info">
                    <div class="status-row">
                        <span class="status-label">Connection</span>
                        <span class="status-value" id="teams-connection">
                            <span class="badge danger">Disconnected</span>
                        </span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">In Meeting</span>
                        <span class="status-value" id="teams-meeting">No</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Muted</span>
                        <span class="status-value" id="teams-muted">-</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Video</span>
                        <span class="status-value" id="teams-video">-</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Hand Raised</span>
                        <span class="status-value" id="teams-hand">-</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="logs-section">
            <div class="log-card">
                <h3>Device Logs</h3>
                <div class="log-entries" id="device-logs"></div>
            </div>

            <div class="log-card">
                <h3>Teams Logs</h3>
                <div class="log-entries" id="teams-logs"></div>
            </div>
        </div>
            </main>
        </div>

        <!-- Configuration Tab -->
        <div id="config" class="tab-content">
            <main>
                <div id="config-alert"></div>
                
                <div class="config-section">
                    <div class="editor-toggle">
                        <button class="btn btn-primary" id="visual-mode-btn" onclick="switchEditorMode('visual')">Visual Editor</button>
                        <button class="btn btn-primary" id="yaml-mode-btn" onclick="switchEditorMode('yaml')">YAML Editor</button>
                    </div>

                    <!-- YAML Editor Mode -->
                    <div id="yaml-editor-mode" class="editor-mode active">
                        <h3>YAML Configuration Editor</h3>
                        <p style="margin-bottom: 1rem; color: #666;">
                            Edit the configuration directly in YAML format. Changes will be validated before saving.
                        </p>
                        <div class="form-group">
                            <label for="config-yaml">Configuration (YAML)</label>
                            <textarea id="config-yaml" class="code-editor"></textarea>
                        </div>
                    </div>

                    <!-- Visual Editor Mode -->
                    <div id="visual-editor-mode" class="editor-mode">
                        <h3>Visual Configuration Editor</h3>
                        <p style="margin-bottom: 1rem; color: #666;">
                            Configure your buttons and settings using forms and dropdowns.
                        </p>

                        <!-- Button Actions -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">Button Actions</h4>
                            <div id="button-actions-list"></div>
                            <button class="btn btn-sm btn-primary" onclick="addButtonAction()">+ Add Button Action</button>
                        </div>

                        <!-- Longpress Actions -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">Long Press Actions</h4>
                            <div id="longpress-actions-list"></div>
                            <button class="btn btn-sm btn-primary" onclick="addLongpressAction()">+ Add Long Press Action</button>
                        </div>

                        <!-- LED Status -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">LED Status Configurations</h4>
                            <div id="led-status-list"></div>
                            <button class="btn btn-sm btn-primary" onclick="addLedStatus()">+ Add LED Config</button>
                        </div>

                        <!-- Device Identifications -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">Device Identifications</h4>
                            <div id="device-list"></div>
                            <button class="btn btn-sm btn-primary" onclick="addDevice()">+ Add Device</button>
                        </div>
                    </div>

                    <div class="config-actions">
                        <button class="btn btn-success" onclick="saveConfig()">Save Configuration</button>
                        <button class="btn btn-primary" onclick="loadConfig()">Reload from File</button>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Quick Stats</h3>
                    <div class="grid-2">
                        <div class="status-row">
                            <span class="status-label">Total Buttons</span>
                            <span class="status-value" id="total-buttons">-</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Device Count</span>
                            <span class="status-value" id="device-count">-</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">LED Configs</span>
                            <span class="status-value" id="led-configs">-</span>
                        </div>
                        <div class="status-row">
                            <span class="status-label">Longpress Actions</span>
                            <span class="status-value" id="longpress-count">-</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <footer>
        <small>&copy; 2025 Matthias Bilger</small>
    </footer>

    <script>
        // Tab functionality
        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    button.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                    
                    // Load config when switching to config tab
                    if (tabName === 'config') {
                        loadConfig();
                    }
                });
            });
        });

        let currentConfig = null;
        let editorMode = 'yaml'; // 'yaml' or 'visual'

        // Editor mode switching
        function switchEditorMode(mode) {
            editorMode = mode;
            document.getElementById('yaml-editor-mode').classList.remove('active');
            document.getElementById('visual-editor-mode').classList.remove('active');
            
            if (mode === 'yaml') {
                document.getElementById('yaml-editor-mode').classList.add('active');
                document.getElementById('yaml-mode-btn').classList.add('btn-primary');
                document.getElementById('visual-mode-btn').classList.remove('btn-primary');
                document.getElementById('visual-mode-btn').classList.add('btn-secondary');
                // Sync from visual to YAML
                if (currentConfig) {
                    syncVisualToYaml();
                }
            } else {
                document.getElementById('visual-editor-mode').classList.add('active');
                document.getElementById('visual-mode-btn').classList.add('btn-primary');
                document.getElementById('yaml-mode-btn').classList.remove('btn-primary');
                document.getElementById('yaml-mode-btn').classList.add('btn-secondary');
                // Sync from YAML to visual
                syncYamlToVisual();
            }
        }

        function syncYamlToVisual() {
            try {
                const yamlText = document.getElementById('config-yaml').value;
                currentConfig = jsyaml.load(yamlText);
                renderVisualEditor();
            } catch (error) {
                console.error('Failed to parse YAML:', error);
            }
        }

        function syncVisualToYaml() {
            if (currentConfig) {
                const yaml = jsyaml.dump(currentConfig, { indent: 2, lineWidth: -1 });
                document.getElementById('config-yaml').value = yaml;
            }
        }

        function renderVisualEditor() {
            if (!currentConfig) return;
            
            // Render devices
            renderDeviceList();
            // Render button actions
            renderButtonActionsList();
            // Render longpress actions
            renderLongpressActionsList();
            // Render LED status
            renderLedStatusList();
        }

        // Device management
        function renderDeviceList() {
            const container = document.getElementById('device-list');
            if (!currentConfig.device_identifications) {
                currentConfig.device_identifications = [];
            }
            
            container.innerHTML = currentConfig.device_identifications.map((device, index) => `
                <div class="button-config-item">
                    <h4>
                        Device ${index + 1}
                        <button class="btn btn-sm btn-danger" onclick="removeDevice(${index})">Remove</button>
                    </h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Vendor ID</label>
                            <input type="number" value="${device.vendor_id}" 
                                onchange="updateDevice(${index}, 'vendor_id', parseInt(this.value))">
                        </div>
                        <div class="form-group">
                            <label>Product ID</label>
                            <input type="number" value="${device.product_id}"
                                onchange="updateDevice(${index}, 'product_id', parseInt(this.value))">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addDevice() {
            if (!currentConfig.device_identifications) {
                currentConfig.device_identifications = [];
            }
            currentConfig.device_identifications.push({ vendor_id: 0, product_id: 0 });
            renderDeviceList();
        }

        function removeDevice(index) {
            currentConfig.device_identifications.splice(index, 1);
            renderDeviceList();
        }

        function updateDevice(index, field, value) {
            currentConfig.device_identifications[index][field] = value;
        }

        // ========== SHARED ACTION CONFIGURATION FUNCTIONS ==========
        // These functions work for both button actions and longpress actions
        // to eliminate code duplication

        // Configuration type mapping
        const CONFIG_TYPES = {
            ACTIONS: 'actions',
            LONGPRESS: 'longpress_action'
        };

        // Get the configuration array for a given prefix
        function getConfigArray(prefix) {
            return currentConfig[prefix] || [];
        }

        // Get the appropriate render function for a prefix
        function getRenderFunction(prefix) {
            return prefix === CONFIG_TYPES.ACTIONS ? renderButtonActionsList : renderLongpressActionsList;
        }

        // Get display label for button
        function getButtonLabel(prefix, buttonId) {
            return prefix === CONFIG_TYPES.ACTIONS ? `Button ${buttonId}` : `Long Press Button ${buttonId}`;
        }

        // Shared function to render actions list
        function renderActionsList(actions, prefix, container) {
            if (!actions) {
                actions = [];
            }
            
            container.innerHTML = actions.map((buttonAction, index) => `
                <div class="button-config-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                            <strong>${getButtonLabel(prefix, buttonAction.button_id)}</strong>
                            <label style="margin: 0; white-space: nowrap;">Button ID:</label>
                            <input type="number" min="1" max="255" value="${buttonAction.button_id}" style="width: 80px; padding: 0.3rem;"
                                onchange="updateButtonId('${prefix}', ${index}, parseInt(this.value))">
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="addActionToButton('${prefix}', ${index})">+ Add Action</button>
                        <button class="btn btn-sm btn-danger" onclick="removeButtonAction('${prefix}', ${index})">Remove</button>
                    </div>
                    <div>
                        ${renderActionsForButton(buttonAction.actions, index, prefix)}
                    </div>
                </div>
            `).join('');
        }

        // Shared function to render individual actions
        function renderActionsForButton(actions, buttonIndex, prefix) {
            if (!actions || actions.length === 0) return '<p style="color: #999;">No actions configured</p>';
            
            return actions.map((action, actionIndex) => {
                const actionType = getActionType(action);
                const dropdownId = `${prefix}-dropdown-${buttonIndex}-${actionIndex}`;
                return `
                    <div class="action-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; position: relative;">
                                <span class="action-type-badge" onclick="toggleActionTypeDropdown('${dropdownId}', event)">
                                    ${actionType} â–¾
                                </span>
                                <div id="${dropdownId}" class="action-type-dropdown">
                                    <div class="action-type-dropdown-item" onclick="changeActionTypeFromDropdown('${prefix}', ${buttonIndex}, ${actionIndex}, 'teams-action', '${dropdownId}')">Teams Action</div>
                                    <div class="action-type-dropdown-item" onclick="changeActionTypeFromDropdown('${prefix}', ${buttonIndex}, ${actionIndex}, 'teams-reaction', '${dropdownId}')">Teams Reaction</div>
                                    <div class="action-type-dropdown-item" onclick="changeActionTypeFromDropdown('${prefix}', ${buttonIndex}, ${actionIndex}, 'activate-teams', '${dropdownId}')">Activate Teams</div>
                                    <div class="action-type-dropdown-item" onclick="changeActionTypeFromDropdown('${prefix}', ${buttonIndex}, ${actionIndex}, 'keyboard', '${dropdownId}')">Keyboard</div>
                                    <div class="action-type-dropdown-item" onclick="changeActionTypeFromDropdown('${prefix}', ${buttonIndex}, ${actionIndex}, 'mouse', '${dropdownId}')">Mouse</div>
                                    <div class="action-type-dropdown-item" onclick="changeActionTypeFromDropdown('${prefix}', ${buttonIndex}, ${actionIndex}, 'command', '${dropdownId}')">Command</div>
                                </div>
                            </div>
                            <div style="flex: 1;">
                                ${renderActionFields(action, buttonIndex, actionIndex, prefix)}
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="removeAction('${prefix}', ${buttonIndex}, ${actionIndex})">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Button actions management
        function renderButtonActionsList() {
            const container = document.getElementById('button-actions-list');
            if (!currentConfig.actions) {
                currentConfig.actions = [];
            }
            renderActionsList(currentConfig.actions, CONFIG_TYPES.ACTIONS, container);
        }

        function getActionType(action) {
            if (action.meeting_action) return 'Teams Action';
            if (action.teams_reaction) return 'Teams Reaction';
            if (action.keyboard) return 'Keyboard';
            if (action.mouse) return 'Mouse';
            if (action.command) return 'Command';
            if (action.webhook) return 'Webhook';
            if (action.activate_teams) return 'Activate Teams';
            return 'Unknown';
        }

        function getKeyboardSubType(action) {
            if (!action.keyboard) return null;
            if (action.keyboard.tap) return 'tap';
            if (action.keyboard.type) return 'type';
            if (action.keyboard.press) return 'press';
            if (action.keyboard.release) return 'release';
            return null;
        }

        function getMouseSubType(action) {
            if (!action.mouse) return null;
            if (action.mouse.move) return 'move';
            if (action.mouse.set) return 'set';
            if (action.mouse.click) return 'click';
            if (action.mouse.hold) return 'hold';
            if (action.mouse.release) return 'release';
            return null;
        }

        function renderActionFields(action, buttonIndex, actionIndex, prefix) {
            let html = '';
            
            // Meeting action
            if (action.meeting_action) {
                html += `
                    <div class="form-group-inline">
                        <select onchange="updateActionField('${prefix}', ${buttonIndex}, ${actionIndex}, 'meeting_action', this.value)">
                            ${getMeetingActionOptions(action.meeting_action)}
                        </select>
                    </div>
                `;
            }
            
            // Teams reaction
            if (action.teams_reaction) {
                html += `
                    <div class="form-group-inline">
                        <select onchange="updateReaction('${prefix}', ${buttonIndex}, ${actionIndex}, this.value)">
                            ${getReactionOptions(action.teams_reaction.reaction)}
                        </select>
                    </div>
                `;
            }
            
            // Command
            if (action.command) {
                html += `
                    <div class="form-group-inline">
                        <input type="text" value="${action.command}" 
                            onchange="updateActionField('${prefix}', ${buttonIndex}, ${actionIndex}, 'command', this.value)">
                    </div>
                `;
            }
            
            // Keyboard
            if (action.keyboard) {
                const kbSubType = getKeyboardSubType(action);
                html += `
                    <div class="form-group-inline">
                        <select onchange="changeKeyboardSubType('${prefix}', ${buttonIndex}, ${actionIndex}, this.value)" style="max-width: 120px;">
                            <option value="tap" ${kbSubType === 'tap' ? 'selected' : ''}>Tap</option>
                            <option value="type" ${kbSubType === 'type' ? 'selected' : ''}>Type</option>
                            <option value="press" ${kbSubType === 'press' ? 'selected' : ''}>Press</option>
                            <option value="release" ${kbSubType === 'release' ? 'selected' : ''}>Release</option>
                        </select>
                `;
                if (action.keyboard.tap) {
                    html += `
                        <input type="text" value="${action.keyboard.tap.key || ''}" placeholder="Key" style="max-width: 100px;"
                            onchange="updateKeyboardTap('${prefix}', ${buttonIndex}, ${actionIndex}, 'key', this.value)">
                        <label>Modifiers:</label>
                        <input type="text" value="${(action.keyboard.tap.modifiers || []).join(', ')}" placeholder="ctrl, shift, alt"
                            onchange="updateKeyboardTapModifiers('${prefix}', ${buttonIndex}, ${actionIndex}, this.value)">
                    `;
                } else if (action.keyboard.type) {
                    html += `
                        <input type="text" value="${action.keyboard.type.string || ''}" placeholder="Text to type"
                            onchange="updateKeyboardType('${prefix}', ${buttonIndex}, ${actionIndex}, this.value)">
                    `;
                } else if (action.keyboard.press) {
                    html += `
                        <input type="text" value="${action.keyboard.press.key || ''}" placeholder="Key" style="max-width: 100px;"
                            onchange="updateKeyboardPress('${prefix}', ${buttonIndex}, ${actionIndex}, 'key', this.value)">
                        <label>Modifiers:</label>
                        <input type="text" value="${(action.keyboard.press.modifiers || []).join(', ')}" placeholder="ctrl, shift, alt"
                            onchange="updateKeyboardPressModifiers('${prefix}', ${buttonIndex}, ${actionIndex}, this.value)">
                    `;
                } else if (action.keyboard.release) {
                    html += `
                        <input type="text" value="${action.keyboard.release.key || ''}" placeholder="Key" style="max-width: 100px;"
                            onchange="updateKeyboardRelease('${prefix}', ${buttonIndex}, ${actionIndex}, 'key', this.value)">
                        <label>Modifiers:</label>
                        <input type="text" value="${(action.keyboard.release.modifiers || []).join(', ')}" placeholder="ctrl, shift, alt"
                            onchange="updateKeyboardReleaseModifiers('${prefix}', ${buttonIndex}, ${actionIndex}, this.value)">
                    `;
                }
                html += `</div>`;
            }
            
            // Mouse
            if (action.mouse) {
                const mouseSubType = getMouseSubType(action);
                html += `
                    <div class="form-group-inline">
                        <select onchange="changeMouseSubType('${prefix}', ${buttonIndex}, ${actionIndex}, this.value)" style="max-width: 120px;">
                            <option value="move" ${mouseSubType === 'move' ? 'selected' : ''}>Move</option>
                            <option value="set" ${mouseSubType === 'set' ? 'selected' : ''}>Set Position</option>
                            <option value="click" ${mouseSubType === 'click' ? 'selected' : ''}>Click</option>
                            <option value="hold" ${mouseSubType === 'hold' ? 'selected' : ''}>Hold</option>
                            <option value="release" ${mouseSubType === 'release' ? 'selected' : ''}>Release</option>
                        </select>
                `;
                if (action.mouse.move) {
                    html += `
                        <label>X:</label>
                        <input type="number" value="${action.mouse.move.x}" placeholder="X" style="max-width: 80px;"
                            onchange="updateMouseMove('${prefix}', ${buttonIndex}, ${actionIndex}, 'x', parseInt(this.value))">
                        <label>Y:</label>
                        <input type="number" value="${action.mouse.move.y}" placeholder="Y" style="max-width: 80px;"
                            onchange="updateMouseMove('${prefix}', ${buttonIndex}, ${actionIndex}, 'y', parseInt(this.value))">
                    `;
                } else if (action.mouse.set) {
                    html += `
                        <label>X:</label>
                        <input type="number" value="${action.mouse.set.x}" placeholder="X" style="max-width: 80px;"
                            onchange="updateMouseSet('${prefix}', ${buttonIndex}, ${actionIndex}, 'x', parseInt(this.value))">
                        <label>Y:</label>
                        <input type="number" value="${action.mouse.set.y}" placeholder="Y" style="max-width: 80px;"
                            onchange="updateMouseSet('${prefix}', ${buttonIndex}, ${actionIndex}, 'y', parseInt(this.value))">
                    `;
                } else if (action.mouse.click || action.mouse.hold || action.mouse.release) {
                    const button = (action.mouse.click || action.mouse.hold || action.mouse.release).button;
                    const updateFunc = action.mouse.click ? 'updateMouseClick' : (action.mouse.hold ? 'updateMouseHold' : 'updateMouseRelease');
                    html += `
                        <label>Button:</label>
                        <select onchange="${updateFunc}('${prefix}', ${buttonIndex}, ${actionIndex}, this.value)" style="max-width: 100px;">
                            <option value="left" ${button === 'left' ? 'selected' : ''}>Left</option>
                            <option value="right" ${button === 'right' ? 'selected' : ''}>Right</option>
                            <option value="middle" ${button === 'middle' ? 'selected' : ''}>Middle</option>
                        </select>
                    `;
                }
                html += `</div>`;
            }
            
            return html;
        }

        function getMeetingActionOptions(selected) {
            const options = [
                'toggle-mute', 'mute', 'unmute',
                'toggle-video', 'show-video', 'hide-video',
                'toggle-hand', 'raise-hand', 'lower-hand',
                'toggle-background-blur', 'blur-background', 'unblur-background',
                'leave-call', 'query-state', 'toggle-ui', 'stop-sharing', 'none'
            ];
            return options.map(opt => `<option value="${opt}" ${opt === selected ? 'selected' : ''}>${opt}</option>`).join('');
        }

        function getReactionOptions(selected) {
            const options = ['like', 'love', 'applause', 'laugh', 'wow', 'chat', 'sharing-tray'];
            return options.map(opt => `<option value="${opt}" ${opt === selected ? 'selected' : ''}>${opt}</option>`).join('');
        }

        function addButtonAction(prefix) {
            const configArray = getConfigArray(prefix);
            const newId = configArray.length > 0 
                ? Math.max(...configArray.map(a => a.button_id)) + 1 
                : 1;
            configArray.push({
                button_id: newId,
                actions: []
            });
            getRenderFunction(prefix)();
        }

        function removeButtonAction(prefix, index) {
            const configArray = getConfigArray(prefix);
            configArray.splice(index, 1);
            getRenderFunction(prefix)();
        }

        function updateButtonId(prefix, index, newId) {
            const configArray = getConfigArray(prefix);
            configArray[index].button_id = newId;
        }

        function addActionToButton(prefix, buttonIndex) {
            const configArray = getConfigArray(prefix);
            if (!configArray[buttonIndex].actions) {
                configArray[buttonIndex].actions = [];
            }
            // Add a default Teams action
            configArray[buttonIndex].actions.push({
                meeting_action: 'toggle-mute'
            });
            getRenderFunction(prefix)();
        }

        function removeAction(prefix, buttonIndex, actionIndex) {
            const configArray = getConfigArray(prefix);
            configArray[buttonIndex].actions.splice(actionIndex, 1);
            getRenderFunction(prefix)();
        }

        function changeActionType(prefix, buttonIndex, actionIndex, type) {
            const newAction = {};
            
            switch(type) {
                case 'teams-action':
                    newAction.meeting_action = 'toggle-mute';
                    break;
                case 'teams-reaction':
                    newAction.teams_reaction = { reaction: 'like' };
                    break;
                case 'activate-teams':
                    newAction.activate_teams = true;
                    break;
                case 'keyboard':
                    newAction.keyboard = { tap: { key: 'space', modifiers: [] } };
                    break;
                case 'mouse':
                    newAction.mouse = { click: { button: 'left' } };
                    break;
                case 'command':
                    newAction.command = '';
                    break;
                default:
                    return;
            }
            
            const configArray = getConfigArray(prefix);
            configArray[buttonIndex].actions[actionIndex] = newAction;
            getRenderFunction(prefix)();
        }

        function toggleActionTypeDropdown(dropdownId, event) {
            event.stopPropagation();
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.action-type-dropdown');
            
            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                }
            });
            
            dropdown.classList.toggle('show');
        }

        function changeActionTypeFromDropdown(prefix, buttonIndex, actionIndex, type, dropdownId) {
            changeActionType(prefix, buttonIndex, actionIndex, type);
            document.getElementById(dropdownId).classList.remove('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.action-type-badge')) {
                document.querySelectorAll('.action-type-dropdown').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });

        function updateActionField(prefix, buttonIndex, actionIndex, field, value) {
            const configArray = getConfigArray(prefix);
            configArray[buttonIndex].actions[actionIndex][field] = value;
        }

        function updateReaction(prefix, buttonIndex, actionIndex, reaction) {
            const configArray = getConfigArray(prefix);
            configArray[buttonIndex].actions[actionIndex].teams_reaction = { reaction };
        }

        function changeKeyboardSubType(prefix, buttonIndex, actionIndex, subType) {
            const configArray = getConfigArray(prefix);
            const action = configArray[buttonIndex].actions[actionIndex];
            delete action.keyboard;
            switch(subType) {
                case 'tap':
                    action.keyboard = { tap: { key: 'space', modifiers: [] } };
                    break;
                case 'type':
                    action.keyboard = { type: { string: '' } };
                    break;
                case 'press':
                    action.keyboard = { press: { key: 'space', modifiers: [] } };
                    break;
                case 'release':
                    action.keyboard = { release: { key: 'space', modifiers: [] } };
                    break;
            }
            getRenderFunction(prefix)();
        }

        function changeMouseSubType(prefix, buttonIndex, actionIndex, subType) {
            const configArray = getConfigArray(prefix);
            const action = configArray[buttonIndex].actions[actionIndex];
            delete action.mouse;
            switch(subType) {
                case 'move':
                    action.mouse = { move: { x: 0, y: 0 } };
                    break;
                case 'set':
                    action.mouse = { set: { x: 0, y: 0 } };
                    break;
                case 'click':
                    action.mouse = { click: { button: 'left' } };
                    break;
                case 'hold':
                    action.mouse = { hold: { button: 'left' } };
                    break;
                case 'release':
                    action.mouse = { release: { button: 'left' } };
                    break;
            }
            getRenderFunction(prefix)();
        }

        function updateKeyboardTap(prefix, buttonIndex, actionIndex, field, value) {
            const configArray = getConfigArray(prefix);
            if (!configArray[buttonIndex].actions[actionIndex].keyboard.tap) {
                configArray[buttonIndex].actions[actionIndex].keyboard.tap = {};
            }
            configArray[buttonIndex].actions[actionIndex].keyboard.tap[field] = value;
        }

        function updateKeyboardTapModifiers(prefix, buttonIndex, actionIndex, value) {
            const configArray = getConfigArray(prefix);
            const modifiers = value.split(',').map(m => m.trim()).filter(m => m);
            if (!configArray[buttonIndex].actions[actionIndex].keyboard.tap) {
                configArray[buttonIndex].actions[actionIndex].keyboard.tap = {};
            }
            configArray[buttonIndex].actions[actionIndex].keyboard.tap.modifiers = modifiers;
        }

        function updateKeyboardType(prefix, buttonIndex, actionIndex, value) {
            const configArray = getConfigArray(prefix);
            configArray[buttonIndex].actions[actionIndex].keyboard.type = { string: value };
        }

        function updateKeyboardPress(prefix, buttonIndex, actionIndex, field, value) {
            const configArray = getConfigArray(prefix);
            if (!configArray[buttonIndex].actions[actionIndex].keyboard.press) {
                configArray[buttonIndex].actions[actionIndex].keyboard.press = {};
            }
            configArray[buttonIndex].actions[actionIndex].keyboard.press[field] = value;
        }

        function updateKeyboardPressModifiers(prefix, buttonIndex, actionIndex, value) {
            const configArray = getConfigArray(prefix);
            const modifiers = value.split(',').map(m => m.trim()).filter(m => m);
            if (!configArray[buttonIndex].actions[actionIndex].keyboard.press) {
                configArray[buttonIndex].actions[actionIndex].keyboard.press = {};
            }
            configArray[buttonIndex].actions[actionIndex].keyboard.press.modifiers = modifiers;
        }

        function updateKeyboardRelease(prefix, buttonIndex, actionIndex, field, value) {
            const configArray = getConfigArray(prefix);
            if (!configArray[buttonIndex].actions[actionIndex].keyboard.release) {
                configArray[buttonIndex].actions[actionIndex].keyboard.release = {};
            }
            configArray[buttonIndex].actions[actionIndex].keyboard.release[field] = value;
        }

        function updateKeyboardReleaseModifiers(prefix, buttonIndex, actionIndex, value) {
            const configArray = getConfigArray(prefix);
            const modifiers = value.split(',').map(m => m.trim()).filter(m => m);
            if (!configArray[buttonIndex].actions[actionIndex].keyboard.release) {
                configArray[buttonIndex].actions[actionIndex].keyboard.release = {};
            }
            configArray[buttonIndex].actions[actionIndex].keyboard.release.modifiers = modifiers;
        }

        function updateMouseMove(prefix, buttonIndex, actionIndex, field, value) {
            const configArray = getConfigArray(prefix);
            if (!configArray[buttonIndex].actions[actionIndex].mouse.move) {
                configArray[buttonIndex].actions[actionIndex].mouse.move = { x: 0, y: 0 };
            }
            configArray[buttonIndex].actions[actionIndex].mouse.move[field] = value;
        }

        function updateMouseSet(prefix, buttonIndex, actionIndex, field, value) {
            const configArray = getConfigArray(prefix);
            if (!configArray[buttonIndex].actions[actionIndex].mouse.set) {
                configArray[buttonIndex].actions[actionIndex].mouse.set = { x: 0, y: 0 };
            }
            configArray[buttonIndex].actions[actionIndex].mouse.set[field] = value;
        }

        function updateMouseClick(prefix, buttonIndex, actionIndex, button) {
            const configArray = getConfigArray(prefix);
            configArray[buttonIndex].actions[actionIndex].mouse.click = { button };
        }

        function updateMouseHold(prefix, buttonIndex, actionIndex, button) {
            const configArray = getConfigArray(prefix);
            configArray[buttonIndex].actions[actionIndex].mouse.hold = { button };
        }

        function updateMouseRelease(prefix, buttonIndex, actionIndex, button) {
            const configArray = getConfigArray(prefix);
            configArray[buttonIndex].actions[actionIndex].mouse.release = { button };
        }

        // Longpress actions management - now uses shared functions with wrappers
        function renderLongpressActionsList() {
            const container = document.getElementById('longpress-actions-list');
            if (!currentConfig.longpress_action) {
                currentConfig.longpress_action = [];
            }
            renderActionsList(currentConfig.longpress_action, CONFIG_TYPES.LONGPRESS, container);
        }

        // Simple wrapper functions for longpress actions
        function addLongpressAction() {
            addButtonAction(CONFIG_TYPES.LONGPRESS);
        }

        function removeLongpressAction(index) {
            removeButtonAction(CONFIG_TYPES.LONGPRESS, index);
        }

        function updateLongpressButtonId(index, newId) {
            updateButtonId(CONFIG_TYPES.LONGPRESS, index, newId);
        }

        function addActionToLongpress(buttonIndex) {
            addActionToButton(CONFIG_TYPES.LONGPRESS, buttonIndex);
        }

        // LED Status management
        function renderLedStatusList() {
            const container = document.getElementById('led-status-list');
            if (!currentConfig.led_status) {
                currentConfig.led_status = [];
            }
            
            container.innerHTML = currentConfig.led_status.map((led, index) => `
                <div class="button-config-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
                            <strong>LED Button ${led.button_id}</strong>
                            <label style="margin: 0; white-space: nowrap;">Button ID:</label>
                            <input type="number" min="1" max="255" value="${led.button_id}" style="width: 80px; padding: 0.3rem;"
                                onchange="updateLedButtonId(${index}, parseInt(this.value))">
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeLedStatus(${index})">Remove</button>
                    </div>
                    ${led.teams_state ? `
                        <div class="form-group-inline">
                            <label>Teams State:</label>
                            <select onchange="updateLedTeamsState(${index}, this.value)">
                                ${getTeamsStateOptions(led.teams_state.teams_state)}
                            </select>
                            <label>Color On:</label>
                            <select onchange="updateLedColor(${index}, 'color_on', this.value)">
                                ${getColorOptions(led.teams_state.color_on)}
                            </select>
                            <label>Color Off:</label>
                            <select onchange="updateLedColor(${index}, 'color_off', this.value)">
                                ${getColorOptions(led.teams_state.color_off)}
                            </select>
                        </div>
                    ` : '<p style="color: #999;">No Teams state configured</p>'}
                </div>
            `).join('');
        }

        function getTeamsStateOptions(selected) {
            const options = ['is-muted', 'is-hand-raised', 'is-video-on', 'is-in-meeting', 
                           'is-recording-on', 'is-background-blurred', 'is-sharing', 'has-unread-messages'];
            return options.map(opt => `<option value="${opt}" ${opt === selected ? 'selected' : ''}>${opt}</option>`).join('');
        }

        function getColorOptions(selected) {
            const colors = ['black', 'red', 'green', 'blue', 'yellow', 'cyan', 'magenta', 'white', 'orange', 'purple'];
            return colors.map(color => `<option value="${color}" ${color === selected ? 'selected' : ''}>${color}</option>`).join('');
        }

        function addLedStatus() {
            if (!currentConfig.led_status) currentConfig.led_status = [];
            const newId = currentConfig.led_status.length > 0 
                ? Math.max(...currentConfig.led_status.map(l => l.button_id)) + 1 
                : 1;
            currentConfig.led_status.push({
                button_id: newId,
                webhook: false,
                teams_state: {
                    teams_state: 'is-muted',
                    color_on: 'green',
                    color_off: 'red'
                }
            });
            renderLedStatusList();
        }

        function removeLedStatus(index) {
            currentConfig.led_status.splice(index, 1);
            renderLedStatusList();
        }

        function updateLedButtonId(index, newId) {
            currentConfig.led_status[index].button_id = newId;
        }

        function updateLedTeamsState(index, state) {
            if (!currentConfig.led_status[index].teams_state) {
                currentConfig.led_status[index].teams_state = {};
            }
            currentConfig.led_status[index].teams_state.teams_state = state;
        }

        function updateLedColor(index, field, color) {
            if (!currentConfig.led_status[index].teams_state) {
                currentConfig.led_status[index].teams_state = {};
            }
            currentConfig.led_status[index].teams_state[field] = color;
        }

        // Config management functions
        async function loadConfig() {
            try {
                const invoke = getInvokeFunction();
                if (!invoke) {
                    showConfigAlert('Tauri IPC not ready', 'error');
                    return;
                }

                currentConfig = await invoke('get_config', {});
                const yaml = jsyaml.dump(currentConfig, { indent: 2, lineWidth: -1 });
                document.getElementById('config-yaml').value = yaml;
                
                if (editorMode === 'visual') {
                    renderVisualEditor();
                }
                
                updateConfigStats(currentConfig);
                showConfigAlert('Configuration loaded successfully', 'success');
            } catch (error) {
                console.error('Failed to load config:', error);
                showConfigAlert('Failed to load configuration: ' + error, 'error');
            }
        }

        async function saveConfig() {
            try {
                const invoke = getInvokeFunction();
                if (!invoke) {
                    showConfigAlert('Tauri IPC not ready', 'error');
                    return;
                }

                let config;
                if (editorMode === 'yaml') {
                    const yamlText = document.getElementById('config-yaml').value;
                    config = jsyaml.load(yamlText);
                } else {
                    // In visual mode, currentConfig is already updated
                    config = currentConfig;
                }
                
                await invoke('save_config', { config });
                currentConfig = config;
                
                // Update both editors
                const yaml = jsyaml.dump(config, { indent: 2, lineWidth: -1 });
                document.getElementById('config-yaml').value = yaml;
                if (editorMode === 'visual') {
                    renderVisualEditor();
                }
                
                updateConfigStats(config);
                showConfigAlert('Configuration saved successfully!', 'success');
            } catch (error) {
                console.error('Failed to save config:', error);
                showConfigAlert('Failed to save configuration: ' + error, 'error');
            }
        }

        function updateConfigStats(config) {
            document.getElementById('total-buttons').textContent = config.actions?.length || 0;
            document.getElementById('device-count').textContent = config.device_identifications?.length || 0;
            document.getElementById('led-configs').textContent = config.led_status?.length || 0;
            document.getElementById('longpress-count').textContent = config.longpress_action?.length || 0;
        }

        function showConfigAlert(message, type) {
            const alertDiv = document.getElementById('config-alert');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function getInvokeFunction() {
            let invoke = window.__TAURI_INVOKE__;
            if (!invoke && window.__TAURI_INTERNALS__) {
                invoke = (cmd, args) => window.__TAURI_INTERNALS__.invoke(cmd, args);
            }
            return invoke;
        }

        // Dashboard functions (existing code)
        // Wait for Tauri IPC to be ready
        async function initApp() {
            // Try multiple methods to get invoke function
            let invoke = window.__TAURI_INVOKE__;
            
            if (!invoke && window.__TAURI_INTERNALS__) {
                invoke = (cmd, args) => window.__TAURI_INTERNALS__.invoke(cmd, args);
            }
            
            if (!invoke) {
                console.error('Tauri IPC not available, retrying...');
                setTimeout(initApp, 100);
                return;
            }

            console.log('Tauri IPC ready');

            async function updateStatus() {
                try {
                    const status = await invoke('get_status', {});
                    console.log('Status received:', status);
                    
                    // Update device status
                    const deviceConnected = status.device.connected;
                    document.getElementById('device-indicator').className = 
                        'status-indicator ' + (deviceConnected ? 'connected' : 'disconnected');
                    document.getElementById('device-connection').innerHTML = 
                        `<span class="badge ${deviceConnected ? 'success' : 'danger'}">${deviceConnected ? 'Connected' : 'Disconnected'}</span>`;
                    document.getElementById('device-manufacturer').textContent = status.device.manufacturer || '-';
                    document.getElementById('device-product').textContent = status.device.product || '-';
                    document.getElementById('device-serial').textContent = status.device.serial_number || '-';

                    // Update Teams status
                    const teamsConnected = status.teams.connected;
                    document.getElementById('teams-indicator').className = 
                        'status-indicator ' + (teamsConnected ? 'connected' : 'disconnected');
                    document.getElementById('teams-connection').innerHTML = 
                        `<span class="badge ${teamsConnected ? 'success' : 'danger'}">${teamsConnected ? 'Connected' : 'Disconnected'}</span>`;
                    document.getElementById('teams-meeting').textContent = status.teams.in_meeting ? 'Yes' : 'No';
                    document.getElementById('teams-muted').textContent = status.teams.is_muted ? 'Yes' : 'No';
                    document.getElementById('teams-video').textContent = status.teams.is_video_on ? 'On' : 'Off';
                    document.getElementById('teams-hand').textContent = status.teams.is_hand_raised ? 'Raised' : 'Down';
                } catch (error) {
                    console.error('Failed to update status:', error);
                }
            }

            async function updateLogs() {
                try {
                    const deviceLogs = await invoke('get_device_logs', {});
                    const teamsLogs = await invoke('get_teams_logs', {});

                    // Update device logs
                    const deviceLogsEl = document.getElementById('device-logs');
                    deviceLogsEl.innerHTML = deviceLogs.slice(-50).reverse().map(log => 
                        `<div class="log-entry">
                            <span class="log-timestamp">${log.timestamp}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span class="log-message">${log.message}</span>
                        </div>`
                    ).join('');

                    // Update Teams logs
                    const teamsLogsEl = document.getElementById('teams-logs');
                    teamsLogsEl.innerHTML = teamsLogs.slice(-50).reverse().map(log => 
                        `<div class="log-entry">
                            <span class="log-timestamp">${log.timestamp}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span class="log-message">${log.message}</span>
                        </div>`
                    ).join('');
                } catch (error) {
                    console.error('Failed to update logs:', error);
                }
            }

            // Update every second
            setInterval(() => {
                updateStatus();
                updateLogs();
            }, 1000);

            // Initial update
            updateStatus();
            updateLogs();
        }

        // Start when page loads
        window.addEventListener('load', () => {
            setTimeout(initApp, 50);
        });
    </script>
</body>
</html>
